<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Camera & Mic Permissions Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      padding: 30px;
      display: flex;
      justify-content: center;
    }

    #app {
      width: 450px;
      background: #fff;
      padding: 25px;
      border-radius: 14px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    h2 {
      margin-bottom: 6px;
    }

    .status {
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0;
      font-size: 14px;
      display: none;
    }

    .status.visible { display: block; }
    .status.success { background: #e9ffe9; color: #0b6123; }
    .status.error { background: #ffe8e8; color: #7a1313; }
    .status.info { background: #e8f0ff; color: #234394; }

    button {
      padding: 12px 18px;
      border: none;
      background: #0066ff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 14px;
      width: 100%;
    }

    button:disabled {
      opacity: .6;
      cursor: default;
    }

    video {
      width: 100%;
      margin-top: 15px;
      border-radius: 10px;
      display: none;
    }

    .fix-box {
      padding: 12px;
      background: #fff4d9;
      border-left: 5px solid #ff9900;
      margin-top: 15px;
      border-radius: 8px;
      display: none;
    }
  </style>
</head>

<body>
  <div id="app">
    <h2>Camera & Mic Permission Test</h2>
    <p>This demo shows exactly how Chrome behaves with Allow, Deny, and Block states.</p>

    <div id="status" class="status info visible">
      Click the button below to request camera & mic permissions.
    </div>

    <button id="requestBtn">Request Camera & Mic</button>

    <video id="video" autoplay playsinline muted></video>

    <div class="fix-box" id="fixBox">
      <b>Permissions are blocked!</b><br /><br />
      Chrome has blocked camera/mic access for this site.<br /><br />
      <b>How to fix:</b>
      <ol>
        <li>Click the <b>ðŸ”’ lock icon</b> in the address bar.</li>
        <li>Go to <b>Site settings</b>.</li>
        <li>Set <b>Camera = Allow</b> and <b>Microphone = Allow</b>.</li>
        <li>Reload this page.</li>
      </ol>
    </div>

  </div>

<script>
  const requestBtn = document.getElementById("requestBtn");
  const statusBox = document.getElementById("status");
  const video = document.getElementById("video");
  const fixBox = document.getElementById("fixBox");

  function showStatus(msg, type="info") {
    statusBox.textContent = msg;
    statusBox.className = "status visible " + type;
  }

  async function checkPermissions() {
    if (!navigator.permissions) return null;

    try {
      const cam = await navigator.permissions.query({ name: 'camera' });
      const mic = await navigator.permissions.query({ name: 'microphone' });
      return { cam: cam.state, mic: mic.state };
    } catch (e) {
      return null;
    }
  }

  async function askPermission() {
    showStatus("Requesting camera & micâ€¦ Chrome may show the permission popup", "info");

    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true,
      });

      // SUCCESS
      showStatus("Permissions granted! Camera stream active.", "success");
      video.srcObject = stream;
      video.style.display = "block";
      fixBox.style.display = "none";

    } catch (err) {
      console.warn("Permission Error:", err);

      const perm = await checkPermissions();

      // CASE: User clicked BLOCK (persistent deny)
      if (perm && (perm.cam === "denied" || perm.mic === "denied")) {
        showStatus("Permissions are BLOCKED. Browser will NOT show popup again.", "error");
        fixBox.style.display = "block";
        video.style.display = "none";
        return;
      }

      // CASE: Temporary "Not now" or close popup
      if (err.name === "NotAllowedError") {
        showStatus("Permission denied temporarily. Try again.", "error");
        fixBox.style.display = "none";
        return;
      }

      showStatus("Error: " + err.message, "error");
    }
  }

  requestBtn.addEventListener("click", askPermission);
</script>

</body>
</html>
